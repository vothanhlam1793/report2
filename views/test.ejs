<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR & Barcode Scanner</title>
    <script src="https://unpkg.com/html5-qrcode" defer></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 20px;
        overflow: hidden;
      }

      #reader {
        width: 100%;
        max-width: 400px;
        margin: auto;
        position: relative;
      }

      /* ðŸ”¥ Giá»›i háº¡n chiá»u cao video */
      video {
        width: 100%;
        max-height: 250px;
        object-fit: cover;
      }

      /* ðŸ”¥ Khung quÃ©t - Cá»‘ Ä‘á»‹nh vÃ o video */
      .scanner-border {
        position: absolute;
        width: 80%;
        height: 120px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 4px solid gray;
        box-shadow: 0 0 15px gray;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10;
        transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      }

      /* ðŸ”¥ Khi quÃ©t thÃ nh cÃ´ng -> Nháº¥p nhÃ¡y mÃ u xanh */
      .scanner-success {
        animation: flash-green 0.5s alternate 3;
      }

      @keyframes flash-green {
        0% {
          border-color: gray;
          box-shadow: 0 0 15px gray;
        }
        50% {
          border-color: green;
          box-shadow: 0 0 25px green;
        }
        100% {
          border-color: gray;
          box-shadow: 0 0 15px gray;
        }
      }

      #result {
        margin-top: 20px;
        font-weight: bold;
        font-size: 18px;
        color: green;
      }

      /* ðŸ”¥ NÃºt xin phÃ©p Ã¢m thanh */
      #enable-sound {
        margin-top: 15px;
        padding: 10px 20px;
        font-size: 16px;
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 5px;
      }

      #enable-sound:active {
        background-color: #0056b3;
      }
    </style>
  </head>
  <body>
    <h1>QuÃ©t QR & Barcode</h1>
    <button id="enable-sound">ðŸ”Š Báº­t Ã‚m Thanh</button>
    <div id="reader"></div>
    <p id="result">ðŸ“Œ Káº¿t quáº£ sáº½ hiá»ƒn thá»‹ á»Ÿ Ä‘Ã¢y...</p>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        let audioContext
        let beepBuffer

        // ðŸ”¥ Khá»Ÿi táº¡o Ã¢m thanh nhÆ°ng chÆ°a phÃ¡t
        async function loadBeepSound() {
          if (!audioContext) {
            audioContext = new (window.AudioContext ||
              window.webkitAudioContext)()
          }
          const response = await fetch('/audio/beep-07a.wav')
          const arrayBuffer = await response.arrayBuffer()
          beepBuffer = await audioContext.decodeAudioData(arrayBuffer)
        }

        function playBeep() {
          if (!audioContext || !beepBuffer) return
          const source = audioContext.createBufferSource()
          source.buffer = beepBuffer
          source.connect(audioContext.destination)
          source.start(0)
        }

        // ðŸ”¥ NgÆ°á»i dÃ¹ng nháº¥n nÃºt Ä‘á»ƒ kÃ­ch hoáº¡t Ã¢m thanh
        document
          .getElementById('enable-sound')
          .addEventListener('click', async () => {
            await loadBeepSound()
            playBeep() // Cháº¡y thá»­ má»™t láº§n Ä‘á»ƒ trÃ¬nh duyá»‡t cáº¥p quyá»n
            document.getElementById('enable-sound').style.display = 'none' // áº¨n nÃºt sau khi báº­t
          })

        function addScannerBorder() {
          const scanRegion = document.querySelector('#reader__scan_region')
          if (scanRegion && !document.querySelector('.scanner-border')) {
            const scannerBorder = document.createElement('div')
            scannerBorder.classList.add('scanner-border')

            // ðŸ”¥ áº¨n khung quÃ©t trÃªn iOS
            if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
              scannerBorder.style.display = 'none'
            }

            scanRegion.appendChild(scannerBorder)
          }
        }

        // ðŸ”¥ Kiá»ƒm tra má»—i 500ms náº¿u khung bá»‹ máº¥t thÃ¬ thÃªm láº¡i
        setInterval(addScannerBorder, 500)

        let scanResults = []
        const STABLE_COUNT = 3 // ðŸ”¥ Cáº§n xuáº¥t hiá»‡n 3 láº§n giá»‘ng nhau má»›i hiá»ƒn thá»‹
        let lastScannedText = '' // ðŸ”¥ LÆ°u mÃ£ QR cuá»‘i cÃ¹ng Ä‘á»ƒ trÃ¡nh quÃ©t liÃªn tá»¥c
        const TIMEOUT_BETWEEN_SCANS = 4000 // ðŸ”¥ Thá»i gian chá» giá»¯a 2 láº§n quÃ©t (ms)

        function onScanSuccess(decodedText, decodedResult) {
          // ðŸ”¥ Náº¿u trÃ¹ng vá»›i láº§n quÃ©t cuá»‘i cÃ¹ng vÃ  chÆ°a qua timeout thÃ¬ bá» qua
          if (decodedText === lastScannedText) {
            return
          }

          scanResults.push(decodedText)

          // Äáº¿m sá»‘ láº§n xuáº¥t hiá»‡n cá»§a mÃ£ QR nÃ y
          let count = scanResults.filter(text => text === decodedText).length

          if (count >= STABLE_COUNT) {
            document.getElementById('result').innerText =
              'ðŸ“Œ Káº¿t quáº£: ' + decodedText

            // ðŸ”¥ KÃ­ch hoáº¡t hiá»‡u á»©ng nháº¥p nhÃ¡y mÃ u xanh
            const scannerBorder = document.querySelector('.scanner-border')
            scannerBorder.classList.add('scanner-success')

            // ðŸ”¥ PhÃ¡t Ã¢m thanh "tÃ­t"
            playBeep()

            // ðŸ”¥ Cáº­p nháº­t mÃ£ cuá»‘i cÃ¹ng Ä‘Ã£ quÃ©t
            lastScannedText = decodedText

            // ðŸ”¥ Sau khi nháº¥p nhÃ¡y xong, tá»± Ä‘á»™ng xÃ³a class Ä‘á»ƒ reset
            setTimeout(() => {
              scannerBorder.classList.remove('scanner-success')
            }, 1500)

            // ðŸ”¥ Reset láº¡i bá»™ Ä‘áº¿m
            scanResults = []

            // ðŸ”¥ Sau timeout, cho phÃ©p quÃ©t láº¡i mÃ£ nÃ y
            setTimeout(() => {
              lastScannedText = ''
            }, TIMEOUT_BETWEEN_SCANS)
          }
        }

        function onScanFailure(error) {
          console.warn(`Lá»—i quÃ©t: ${error}`)
        }

        let html5QrcodeScanner = new Html5QrcodeScanner('reader', {
          fps: 5,
          qrbox: { width: 350, height: 120 },
          supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
          experimentalFeatures: { useBarCodeDetectorIfSupported: true },
          videoConstraints: {
            facingMode: 'environment',
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        })

        html5QrcodeScanner.render(onScanSuccess, onScanFailure)
      })
    </script>
  </body>
</html>
