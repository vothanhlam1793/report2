<html>
    <head>
        <%- include('../header.ejs') %>

        
        <script>
            var Invoice = Backbone.Model.extend({
                urlRoot: "/api/invoices"
            })

            var ProductBarcode = Backbone.Model.extend({
                urlRoot: "/api/productBarcodes"
            })
        </script>
        <script>
            var f1 = function(){};
            // console.log("hi");
            function connect() {
                //var ws = new WebSocket("wss://dir.creta.work/public/messagepublish");
                // console.log("aaaa");
                var ws = new WebSocket("ws://node.creta.work:1888/scan_barcode");
                ws.onopen = function() {
                    // subscribe to some channels
                    console.log("opened")
                };
    
                ws.onmessage = function(e) {
                    // var d = JSON.parse(e.data);
                    // if(d.function == 'add_code'){
                    //     app.add_code(d.code);
                    // }
                    // console.log(e.data);
                    var d;
                    try {
                        d = JSON.parse(e.data);
                    } catch(e){
                        d = {code: ""}
                    }
                    f1(d.code);
                    // if(e.data.code){
                        
                    // }
                    // f1(e.data);
                };
    
                ws.onclose = function(e) {
                    // app.not_ready();
                    console.log('Socket is closed. Reconnect will be attempted in 1 second.', e.reason);
                    setTimeout(function() {
                    connect();
                    }, 1000);
                };
    
                ws.onerror = function(err) {
                    console.log(err);
                    console.error('Socket encountered error: ', err.message, 'Closing socket');
                    ws.close();
                };
                return ws;
            }
            connect();
            
        </script>
        <script>
            class ModelInvoiceSMS{
    constructor(){
        // this.ready = false;
        this.invoice = {};
        this.invoice_kiot = {};
        this.onUpdateDate = function(){};
    }
    initInvoice = (code) => {
        var that = this;
        $.ajax({
            url: "/api/invoices/code/" + code,
            method: "GET",
            success: (data) => {
                that.invoice = data;
                that.onUpdateData();
            }
        })
        $.ajax({
            url: "/api/kiot/invoices/" + code,
            method: "GET",
            success: (data) => {
                that.invoice_kiot = data;
                that.onUpdateData();
            }
        })
    }
    send_SMS = (to, msg, msg_count, invoiceCode) => {
        var that = this;
        var url="http://data.creta.work/creta/action/playsms/send_sms.php";
        $.get(url + "?to=" + to + "&msg=" + msg, function(data){
            // console.log(data);
            if(true){
                if(that.invoice.id){
                    // console.log(that.invoice.id);
                    var invoice = new Invoice({id : that.invoice.id});
                    if(that.invoice.actions){
                        that.invoice.actions.push({
                            type: "SEND_SMS",
                            status: "OK",
                            value: msg_count + 1
                        })
                    } else {
                        var invoiceActions = [{
                            type: "SEND_SMS",
                            status: "OK",
                            value: msg_count + 1
                        }]
                        that.invoice.actions = invoiceActions;
                    }                        
                    invoice.set("actions", that.invoice.actions);
                }
                else {
                    var invoice = new Invoice();
                    var invoiceActions = [{
                        type: "SEND_SMS",
                        status: "OK",
                        value: msg_count + 1
                    }]
                    invoice.set("actions", invoiceActions);
                }
                invoice.set("code", invoiceCode);
                invoice.save({},{
                    success: function(r, e){
                        that.initInvoice(invoiceCode);
                        alert("SUCCESS: " + invoiceCode);
                    }
                })
            }
        } )
    }
    get_msg_count = () => {
        var result = 0;
        if(this.invoice.actions){
            if (this.invoice.actions.length > 0){
                var actions_sms = this.invoice.actions.filter((action)=> {
                    return action.type == "SEND_SMS";
                })

                result = actions_sms.length;
            }
        }
        return result;
    }
    get_to = () => {
        var result = "";
        if(this.invoice_kiot.invoiceDelivery){
            result = this.invoice_kiot.invoiceDelivery.contactNumber || "";
        }
        return result;
    }
}
        </script>
        <script></script>
    </head>
    <body>
        <%- include("../menu.ejs"); %>
        <div id="view-detail-invoice">
        

    
            <div class="container" v-if="invoiceModel.invoice_kiot.code">
                <h2>Đơn hàng {{ invoiceModel.invoice_kiot.code }}</h2>
                <button class="btn btn-warning" @click="turn_back()">Trang trước</button>                
                <customer-notes :code="invoiceModel.invoice_kiot.customerCode"></customer-notes>
                <div class="row m-1">
                    <!-- <create-customer-note :code="invoiceModel.invoice_kiot.customerCode" class="col"></create-customer-note> -->
                    <send-invoice-sms :code="invoiceModel.invoice_kiot.code" class="col"></send-invoice-sms>
                    <change-invoice-status :code="invoiceModel.invoice_kiot.code" class="col"></change-invoice-status>
                </div>
                
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <td>Check</td>
                            <td>Tên</td>
                            <td>Số lượng</td>
                            <td>Hành động</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="product in invoiceModel.invoice_kiot.invoiceDetails">
                            <td><input type="checkbox" class="form-control" @change="changeInvoiceProductCheck(invoiceModel.invoice_kiot.code, product.productCode)"></td>
                            <td>{{ product.productName }}</td>
                            <td>{{ product.quantity }}</td>
                            <td><save-barcodes-product :invoice_code="invoiceModel.invoice_kiot.code" :product_code="product.productCode"></save-barcodes-product></td>
                        </tr>
                    </tbody>
                </table>
    
                <invoice-packages code="invoiceModel.invoice_kiot.code"></invoice-packages>
            </div>
        </div>
        
        <script>
            const urlSearchParams = new URLSearchParams(window.location.search);
            const params = Object.fromEntries(urlSearchParams.entries());
            if(!params.code){
                alert("Mã hóa đơn không được để trống");
            }
            var view_detail_invoice = new Vue({
                el: "#view-detail-invoice",
                data: {
                    invoiceModel: new ModelInvoice( params.code )
                },
                methods: {
                    onUpdateData: function(){
                        this.$forceUpdate();
                    },
                    turn_back: function(){
                        window.history.back();
                    }
                },
                created(){
                    this.invoiceModel.onUpdateData = this.onUpdateData;
                }
            })
        </script>
    </body>
    
</html>
